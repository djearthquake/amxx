#include <amxmodx>
#include <amxmisc>
#include <fakemeta>
#include <fun>
#define MAX_NAME_LENGTH 32
new g_cvar_bsod_iDelay, g_mname[MAX_NAME_LENGTH], maxplayers
#define DELAY ewrite_short(get_pcvar_num(g_cvar_bsod_iDelay)*4096) //Remember 4096 is ~1-sec per 'spec unit'

#define FLAGS       ewrite_short(0x0001)

#define FADE_IN     ewrite_short(1<<0)
#define FADE_OUT    ewrite_short(1<<1)
#define FADE_HOLD   ewrite_short(1<<2)

#define ALPHA ewrite_byte(255)


//Screenfade color.

#define BLU ewrite_byte(0);ewrite_byte(0);ewrite_byte(random_num(200,255))

#define GRN ewrite_byte(0);ewrite_byte(random_num(200,255));ewrite_byte(0)

#define PNK ewrite_byte(255);ewrite_byte(random_num(170,200));ewrite_byte(203)

#define PUR ewrite_byte(118);ewrite_byte(random_num(25,75));ewrite_byte(137)
   
#define IS_THERE (~(1<<IN_SCORE))

public plugin_precache()
{
    get_mapname(g_mname, charsmax (g_mname) );
    if (containi(g_mname,"op4c") != -1)
        freeze();
}

public freeze()
{
    pause( "a" );
    return;
}

public plugin_init()
{
    register_plugin("skin_hack_sensor","2.0","SPiNX")
    g_cvar_bsod_iDelay = register_cvar("hacksense_fade_time", "10");
    maxplayers = get_maxplayers()
}


public client_infochanged(id)
if(is_user_connected(id) && is_user_alive(id) && !is_user_bot(id) && (pev(id, pev_button) & IS_THERE) && (pev(id, pev_oldbuttons) & IS_THERE) )
{

    if ( get_user_time(id) > get_pcvar_num(g_cvar_bsod_iDelay) )

    {
        log_amx("suspect|%n", id);
        
        for (new admin=1; admin<=maxplayers; admin++)

        if (is_user_connected(admin) && is_user_admin(admin))
        client_print(admin, print_center, "%n info change detected", id);

        @fadenshake(id);
        @hp_damage_effects(id);

    }


}

@fadenshake(id)
if(is_user_connected(id) && get_user_time(id, 1) > 30)
{
    emessage_begin(MSG_ONE_UNRELIABLE,get_user_msgid("ScreenFade"),{0,0,0},id)
    DELAY;DELAY;FADE_HOLD;PUR;ALPHA; //This is where one can change BLU to GRN.
    emessage_end();

    set_task(float(get_pcvar_num(g_cvar_bsod_iDelay)),"@fadeout", id)
}

@fadeout(id)
if(is_user_connected(id))
{
    emessage_begin(MSG_ONE_UNRELIABLE,get_user_msgid("ScreenFade"),{0,0,0},id)
    DELAY;DELAY;FADE_OUT;GRN;ALPHA; //This is where one can change BLU to GRN.
    emessage_end();

    emessage_begin(MSG_ONE,get_user_msgid("ScreenShake"),{0,0,0},id)
    ewrite_short(25000) //amp
    ewrite_short(get_pcvar_num(g_cvar_bsod_iDelay) * 4096) //dur //4096 is~1sec
    ewrite_short(30000) //freq
    emessage_end()
}


@hp_damage_effects(id)
{
    if(is_user_alive(id))
    {
        new GET_HP = get_user_health(id);
        set_user_health(id, GET_HP--);
    }
}

